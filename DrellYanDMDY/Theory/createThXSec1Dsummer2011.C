// Create a root file with the theory prediction, prepared for 2011 summer
// The errors are a bit strange

#include <TROOT.h>
#include <TSystem.h>
#include <TVector.h>
#include <TFile.h>
#include <TH1F.h>
#include <iostream>

#define Extras

#ifdef Extras
#include "../Include/DYTools.hh"
#include "../Include/MyTools.hh"

const int save_for_massBinLimits2011_1D=1;

#endif

#include <fstream>


const Double_t peak_bin_width = 1.0;
const Double_t peak_val_theory = 1009.0;

inline double SQR(double x) { return (x*x); }

int specRebinCount=202;

// -----------------------------------------------------------------

void rebinCrossSection(const TVectorD &massBins, const TVectorD &XSecTh, const TVectorD &XSecThErr,
		       int newBinCount, const double *newMassBinLimits,
		       TVectorD &newMassBins,
		       TVectorD &newXSec, TVectorD &newXSecErr,
		       TVectorD &newXSecNorm, TVectorD &newXSecNormErr) {
  //
  int locDebug=0;
  const int nMassBinTh=massBins.GetNoElements()-1;
  int iTh=0;
  newMassBins=0; newXSec=0; newXSecErr=0; newXSecNorm=0; newXSecNormErr=0;
  for (int iM=0; iM<newBinCount; ++iM) {
    const double massLo=newMassBinLimits[iM];
    const double massHi=newMassBinLimits[iM+1];
    newMassBins[iM]=massLo;
    newMassBins[iM+1]=massHi;
    if (locDebug) std::cout << "target mass range=" << massLo << " ... " << massHi << "\n";
    for ( ; (iTh<nMassBinTh) && (massBins[iTh]<massHi); ++iTh) {
      if ((massBins[iTh]>=massLo) && (massBins[iTh+1]<=massHi)) {
	if (locDebug) std::cout << "adding entry for mass=" << massBins[iTh] << " (val=" << XSecTh[iTh] << ")\n";
	newXSec[iM]+= XSecTh[iTh];
	newXSecErr[iM]+= SQR(XSecThErr[iTh]);
      }

      // check the next mass bin
      if ((iTh<nMassBinTh) && (massBins[iTh+1]>massHi)) {
	// linear approximation
	// this is a FAILING APPROXIMATION !!!
	double x=(massHi-massBins[iTh])/(massBins[iTh+1]-massBins[iTh]);
	std::cout << "original mass range=" << massBins[iTh] << " ... " << massBins[iTh+1] << ". Linear approximation for massHi=" << massHi << "\n";
	if (locDebug) { 
	  std::cout << "next mass bin ends at " << massBins[iTh+1] << "\n";
	  std::cout << "adding only x=" << x << " fraction to this bin\n";
	}
	newXSec[iM] += x * XSecTh[iTh+1];
	newXSecErr[iM] += SQR( x * XSecThErr[iTh+1] )/(x*x+(1-x)*(1-x));
	if (iM!=newBinCount) {
	  newXSec[iM+1] += (1-x) * XSecTh[iTh+1];
	  newXSecErr[iM+1] += SQR( (1-x) * XSecThErr[iTh+1] )/(x*x + (1-x)*(1-x));
	}
	iTh++;
      }
    }
  }

  for (int iM=0; iM<newBinCount; ++iM) {
    newXSecErr[iM]=sqrt(newXSecErr[iM]);
  }

  // normalize
  for (int iM=0; iM<newBinCount; ++iM) {
    const double dm=newMassBinLimits[iM+1]-newMassBinLimits[iM];
    const double xs=newXSec[iM];
    const double xsErr=newXSecErr[iM];
    newXSecNorm[iM]=xs*peak_bin_width/(peak_val_theory*dm);//divide to the Z peak
    newXSecNormErr[iM]=sqrt(pow(xsErr/(peak_val_theory*dm),2)+pow(xs/(peak_val_theory*2*dm),2));
    if (locDebug) std::cout << "iM=" << iM << ", dM=" << dm << ", newMassBinLimits[iM]=" << newMassBinLimits[iM] << ", newXSec=" << newXSec[iM] << ", normXSec=" << newXSecNorm[iM] << "\n";
  }

  return;
}

// -----------------------------------------------------------------

void rebinCrossSectionSpec(const TVectorD &massBins, const TVectorD &XSecTh, const TVectorD &XSecThErr,
		       TVectorD &newMassBins,
		       TVectorD &newXSec, TVectorD &newXSecErr,
		       TVectorD &newXSecNorm, TVectorD &newXSecNormErr) {
  const int nMassBinTh=518;
  Double_t mxl = 14.0;
  double *massRangeEdges=new double[nMassBinTh+1];

  int iTh_new=0, tmpCounter=0;
  for(int iTh=0; iTh<=nMassBinTh; iTh++, iTh_new++){
    // mass limits
    if     ( iTh >=   0 && iTh <  11 ) {mxl += 1.0;}
    else if( iTh >=  11 && iTh <  18 ) {mxl += 5.0;}
    else if( iTh >=  18 && iTh < 118 ) {mxl += 1.0;}
    else if( iTh >= 118 && iTh < 340 ) {
      if (iTh>=139) {
	//std::cout << "iTh=" << iTh << ", current mxl=" << mxl << " +2\n";
	if (iTh==139) tmpCounter=10;
	tmpCounter--;
	if (tmpCounter>0) iTh_new--;
	else if (tmpCounter==0) {
	  tmpCounter=10;
	  //std::cout << "iTh=" << iTh << ", iTh_new=" << iTh_new << ", current mxl=" << mxl << " +10\n";
	}
      }
      mxl += 2.0;
    }
    else if( iTh >= 340 && iTh < nMassBinTh)   {
      //std::cout << "iTh=" << iTh << ", current mxl=" << mxl << " +5\n";
      if (iTh<342) iTh_new--;
      else {
	if ((iTh-342)%4>0) iTh_new--;
	//else std::cout << "iTh=" << iTh << ", iTh_new=" << iTh_new << ", current mxl=" << mxl << " +10\n";
      }
      mxl += 5.0; 
    }
    else if( iTh == nMassBinTh)                {mxl = 1500; }
    massRangeEdges[iTh_new]=mxl;
  }
  massRangeEdges[iTh_new-2]=1500.;
  std::cout << "iTh_new=" << iTh_new << "\n";

#ifdef MYTOOLS_HH
  if (0) { // check the mass ranges
    TH1F hMassIdx("h_massIdx","h_massIdx",iTh_new-2,massRangeEdges);
    printHisto(&hMassIdx);
  }
#endif

  rebinCrossSection(massBins,XSecTh,XSecThErr,
		    iTh_new-2, massRangeEdges,
		    newMassBins,
		    newXSec, newXSecErr,
		    newXSecNorm, newXSecNormErr);

  delete massRangeEdges;
  //newMassBins.Print();
  return;
}



// -----------------------------------------------------------------

// normalized r-shape taken from muon group (H.D.Yoo)
// "theory r // 11232011 from Stoyan (from fit of theory shape r distribution on the plot)"
// the errors are the ones used in the muon group code

void fillStoyanRShape1D(TVectorD &massBins, TVectorD &normXSec, TVectorD &normXSecErr) {
  // mass min, mass max, xsec, xsecErr
  const double rshape[4*40] = {
    15 , 20 , 0.161196 , 0.00801778
 ,   20 , 25 , 0.0652464 , 0.00301619
 ,   25 , 30 , 0.0324762 , 0.00144218
 ,   30 , 35 , 0.017822 , 0.000756543
 ,   35 , 40 , 0.0104631 , 0.000416689
 ,   40 , 45 , 0.00665895 , 0.0002168
 ,   45 , 50 , 0.00453091 , 0.000139579
 ,   50 , 55 , 0.00328228 , 0.000101962
 ,   55 , 60 , 0.0024752 , 7.30918e-05
 ,   60 , 64 , 0.00205569 , 5.516e-05
 ,   64 , 68 , 0.00191615 , 4.98199e-05
 ,   68 , 72 , 0.00198721 , 5.02729e-05
 ,   72 , 76 , 0.00227068 , 5.61735e-05
 ,   76 , 81 , 0.00335782 , 8.50132e-05
 ,   81 , 86 , 0.00802862 , 0.000201357
 ,   86 , 91 , 0.0760769 , 0.00167376
 ,   91 , 96 , 0.0894752 , 0.00196919
 ,   96 , 101 , 0.00782657 , 0.000219702
 ,   101 , 106 , 0.00260345 , 7.33138e-05
 ,   106 , 110 , 0.00136427 , 3.58883e-05
 ,   110 , 115 , 0.000849739 , 2.2498e-05
 ,   115 , 120 , 0.000555006 , 1.48094e-05
 ,   120 , 126 , 0.000389536 , 1.01129e-05
 ,   126 , 133 , 0.00026674 , 7.00161e-06
 ,   133 , 141 , 0.000183322 , 4.9361e-06
 ,   141 , 150 , 0.000127482 , 3.48192e-06
 ,   150 , 160 , 9.00876e-05 , 2.14892e-06
 ,   160 , 171 , 6.40219e-05 , 1.60055e-06
 ,   171 , 185 , 4.38833e-05 , 1.15188e-06
 ,   185 , 200 , 2.95683e-05 , 8.15678e-07
 ,   200 , 220 , 1.96126e-05 , 5.96494e-07
 ,   220 , 243 , 1.25999e-05 , 4.11382e-07
 ,   243 , 273 , 7.43531e-06 , 2.66221e-07
 ,   273 , 320 , 3.8182e-06 , 1.4935e-07
 ,   320 , 380 , 1.71576e-06 , 7.59987e-08
 ,   380 , 440 , 7.9912e-07 , 3.96834e-08
 ,   440 , 510 , 4.13632e-07 , 2.24317e-08
 ,   510 , 600 , 1.91377e-07 , 1.14459e-08
 ,   600 , 1000 , 3.67528e-08 , 2.62081e-09
 ,   1000 , 1500 , 2.41571e-09 , 2.5735e-10 };

  for (int i=0; i<40; ++i) {
    massBins[i]= rshape[i*4];
  }
  massBins[40]=rshape[39*4+1];

  for (int i=0; i<40; ++i) {
    normXSec[i]= rshape[i*4 + 2];
    normXSecErr[i]= rshape[i*4 + 3];
  }
  return;
}


// -----------------------------------------------------------------


void createThXSec1Dsummer2011() {

  const int nMassBinTh=518;

  const double arr_xsecTh[nMassBinTh] =
 {234.3088990000, 189.5636730000, 154.2339370000, 128.1240230000, 103.3138130000, 89.6849390000, 74.0037640000, 64.8208330000, 55.5298190000, 47.9486180000,
162.2335730000, 87.9219184000, 52.5499102000, 33.4059051000, 22.4922309000, 16.2577520000, 12.4447444000, 2.1452405100, 2.0837222400, 2.0259685600,
2.0091127000, 1.9741387600, 1.9477418100, 1.9413425600, 1.9129359800, 1.9360725600, 1.9730000900, 2.0119539600, 2.0606883600, 2.1536326500,
2.1963802000, 2.3770811800, 2.5336544900, 2.7480582700, 2.9232081300, 3.2941152500, 3.7071633700, 4.1991465600, 5.0589665800, 5.9611963800,
7.2927069000, 9.5088389300, 12.6242665000, 17.8459438000, 26.8549804000, 47.1862349000, 94.3420578000, 193.4938620000, 226.7245430000, 122.1672890000,
57.7738634000, 31.8359832000, 19.5812869000, 12.7883517000, 9.3285398100, 7.0034570000, 5.5074561800, 4.3571058800, 3.5955949200, 3.0099245800,
2.5135813100, 2.1418748000, 1.8890871700, 1.5939531600, 1.4408045800, 1.2911120300, 1.1634632300, 1.0372046300, 0.9186229000, 0.8326196640,
0.7662111410, 0.7150209660, 0.6697220790, 0.6143397590, 0.5682783650, 0.5029516750, 0.4905461680, 0.4526302470, 0.4309129540, 0.4021197160,
0.3768587860, 0.3559064570, 0.3340920250, 0.3154680840, 0.3016650690, 0.2747160610, 0.2685927580, 0.2574719720, 0.2431129250, 0.2298553340,
0.2180590240, 0.2057435990, 0.1967518120, 0.1872268660, 0.1771664660, 0.1740030350, 0.1663401100, 0.1590678370, 0.1459039850, 0.1445823540,
0.1376292810, 0.1311545160, 0.1311336850, 0.1239912920, 0.1180362660, 0.1149302870, 0.1062668660, 0.1081088070, 0.1028612090, 0.1003053510,
0.0937989850, 0.0909142836, 0.0894981253, 0.0863358608, 0.0820310802, 0.0794862585, 0.0773121340, 0.1463999990, 0.1397183200, 0.1299944750,
0.1225224550, 0.1127808020, 0.1100348610, 0.1031091600, 0.0952096627, 0.0918648228, 0.0865855459, 0.0802503113, 0.0749536282, 0.0734436948,
0.0698027879, 0.0659270202, 0.0619270665, 0.0588428705, 0.0553485067, 0.0538149770, 0.0515021235, 0.0473412892, 0.0460651403, 0.0432861343,
0.0427219944, 0.0401107922, 0.0380066631, 0.0371459167, 0.0349539990, 0.0340959551, 0.0323544500, 0.0303585959, 0.0297261195, 0.0287006924,
0.0275281730, 0.0265415395, 0.0249334594, 0.0241343357, 0.0231597500, 0.0222593915, 0.0215118833, 0.0206525641, 0.0191111094, 0.0188281370,
0.0182268621, 0.0178089411, 0.0165238628, 0.0160227432, 0.0157933277, 0.0150331317, 0.0147353842, 0.0142635123, 0.0132977551, 0.0131845078,
0.0124463529, 0.0122147706, 0.0118779377, 0.0110834379, 0.0110813374, 0.0106187710, 0.0100822538, 0.0092940741, 0.0097757750, 0.0092113146,
0.0089035132, 0.0086283755, 0.0084230576, 0.0079958726, 0.0076765890, 0.0074824478, 0.0074846926, 0.0071223561, 0.0069766440, 0.0066123305,
0.0064785037, 0.0062761122, 0.0060616267, 0.0060007252, 0.0057915107, 0.0053961678, 0.0053031536, 0.0050411714, 0.0049715322, 0.0048132170,
0.0047570639, 0.0045781055, 0.0045775359, 0.0042749321, 0.0042580415, 0.0040166830, 0.0040432225, 0.0037669859, 0.0036947583, 0.0035726540,
0.0035402293, 0.0033201286, 0.0034121564, 0.0032878160, 0.0031719171, 0.0028518319, 0.0028657685, 0.0028601061, 0.0027266151, 0.0026423776,
0.0026009907, 0.0025655296, 0.0024587890, 0.0024477675, 0.0023150569, 0.0023981356, 0.0022020057, 0.0022714171, 0.0021538659, 0.0020516644,
0.0019682733, 0.0019201083, 0.0019002827, 0.0018670390, 0.0018276900, 0.0017533989, 0.0017712593, 0.0016882858, 0.0016889946, 0.0016810962,
0.0016416049, 0.0016075080, 0.0015758766, 0.0015407148, 0.0014922012, 0.0014633704, 0.0014350100, 0.0014068149, 0.0013628119, 0.0013336696,
0.0013050581, 0.0012751613, 0.0012443165, 0.0012210761, 0.0012196392, 0.0011942468, 0.0011582827, 0.0011347788, 0.0011125656, 0.0010873757,
0.0010663820, 0.0010453561, 0.0010346534, 0.0010132240, 0.0009943284, 0.0009802604, 0.0009596552, 0.0009380386, 0.0009191294, 0.0009001258,
0.0008705887, 0.0008539690, 0.0008429864, 0.0008285010, 0.0008117547, 0.0007886230, 0.0007744755, 0.0007586493, 0.0007490780, 0.0007362113,
0.0007208215, 0.0007084377, 0.0006949704, 0.0006781920, 0.0006615548, 0.0006503760, 0.0006374327, 0.0006312936, 0.0006181979, 0.0006075874,
0.0005965148, 0.0005859946, 0.0005740594, 0.0005635871, 0.0005526997, 0.0005423626, 0.0005318028, 0.0005213402, 0.0005107406, 0.0005014435,
0.0004927476, 0.0004830730, 0.0004715156, 0.0004632044, 0.0004547493, 0.0004468069, 0.0004357383, 0.0004281298, 0.0004205780, 0.0004121316,
0.0004067348, 0.0003997200, 0.0003912900, 0.0003838492, 0.0003797172, 0.0003733795, 0.0003672665, 0.0003609797, 0.0003545587, 0.0003477687,
0.0003411518, 0.0003346265, 0.0003291462, 0.0003250723, 0.0003197193, 0.0003141892, 0.0003096618, 0.0003048901, 0.0002995848, 0.0002955056,
0.0002902333, 0.0002855474, 0.0002806956, 0.0002755066, 0.0002712229, 0.0002668692, 0.0002625018, 0.0002581071, 0.0002536747, 0.0005858947,
0.0005615481, 0.0005383547, 0.0005162510, 0.0004951796, 0.0004750881, 0.0004559244, 0.0004376402, 0.0004201896, 0.0004035277, 0.0003876141,
0.0003724117, 0.0003578854, 0.0003440010, 0.0003307254, 0.0003180307, 0.0003058867, 0.0002942657, 0.0002831426, 0.0002724940, 0.0002622967,
0.0002525293, 0.0002431718, 0.0002342050, 0.0002256098, 0.0002173694, 0.0002094673, 0.0002018875, 0.0001946154, 0.0001876374, 0.0001809401,
0.0001745104, 0.0001683367, 0.0001624076, 0.0001567121, 0.0001512399, 0.0001459812, 0.0001409269, 0.0001360678, 0.0001313960, 0.0001269031,
0.0001225818, 0.0001184244, 0.0001144242, 0.0001105742, 0.0001068684, 0.0001033008, 0.0000998655, 0.0000965572, 0.0000933706, 0.0000903009,
0.0000873433, 0.0000844929, 0.0000817456, 0.0000790973, 0.0000765442, 0.0000740820, 0.0000717077, 0.0000694177, 0.0000672088, 0.0000650775,
0.0000630207, 0.0000610358, 0.0000591199, 0.0000572703, 0.0000554846, 0.0000537603, 0.0000520951, 0.0000504868, 0.0000489333, 0.0000474324,
0.0000459820, 0.0000445804, 0.0000432257, 0.0000419163, 0.0000406505, 0.0000394266, 0.0000382432, 0.0000370988, 0.0000374046, 0.0000362920,
0.0000352158, 0.0000341745, 0.0000331669, 0.0000321918, 0.0000312481, 0.0000303346, 0.0000294503, 0.0000285942, 0.0000277654, 0.0000269628,
0.0000261856, 0.0000254327, 0.0000247035, 0.0000239971, 0.0000233127, 0.0000226496, 0.0000220071, 0.0000213844, 0.0000207808, 0.0000201959,
0.0000196288, 0.0000190790, 0.0000185459, 0.0000180291, 0.0000175279, 0.0000170419, 0.0000165704, 0.0000161132, 0.0000156696, 0.0000152393,
0.0000148217, 0.0000144165, 0.0000140234, 0.0000136418, 0.0000132715, 0.0000129121, 0.0000125632, 0.0000122246, 0.0000118958, 0.0000115765,
0.0000112665, 0.0000109654, 0.0000106730, 0.0000103891, 0.0000101133, 0.0000098454, 0.0000095851, 0.0000093322, 0.0000090866, 0.0000088478,
0.0000086159, 0.0000083905, 0.0000081714, 0.0000079585, 0.0000077516, 0.0000075504, 0.0000073549, 0.0000071647, 0.0000069799, 0.0000068001,
0.0000066253, 0.0000064554, 0.0000062901, 0.0000061294, 0.0000059731, 0.0000058210, 0.0000056730, 0.0000055291, 0.0000053891, 0.0000052529,
0.0000051203, 0.0000049914, 0.0000048659, 0.0000047438, 0.0000046250, 0.0000045092, 0.0000043967, 0.0000042871, 0.0000041804, 0.0000040765,
0.0000039754, 0.0000038770, 0.0000037811, 0.0000036879, 0.0000035970, 0.0000035085, 0.0000034223, 0.0000033385, 0.0000032567, 0.0000031771,
0.0000030995, 0.0000030240, 0.0000029504, 0.0000028788, 0.0000028089, 0.0000027409, 0.0000026746, 0.0000026100
};
  const double arr_xsecThErr[nMassBinTh] =
  {0.9736090000, 0.4996990000, 0.2661780000, 0.1677890000, 0.1036220000, 0.0759270000, 0.0569500000, 0.0460280000, 0.0377250000, 0.0306410000,
1.5495162000, 0.8373877370, 0.4946190430, 0.3010118260, 0.2176293490, 0.1435376760, 0.1230714480, 0.0195382123, 0.0182393815, 0.0200309467,
0.0189222377, 0.0195810728, 0.0180861909, 0.0166341069, 0.0190250334, 0.0183965323, 0.0177732666, 0.0182856753, 0.0181248944, 0.0206759002,
0.0213877140, 0.0215881383, 0.0230418106, 0.0269436610, 0.0271169456, 0.0280812730, 0.0367120136, 0.0377327575, 0.0488954821, 0.0578837172,
0.0719417462, 0.0814380390, 0.1143605730, 0.1717725120, 0.2417869490, 0.4271109370, 0.9092901730, 1.8468313700, 2.0597027700, 1.0611175100,
0.5680344220, 0.2691415780, 0.1645799110, 0.1239570990, 0.0866360229, 0.0589891264, 0.0470606406, 0.0417405079, 0.0345002135, 0.0275440181,
0.0246678800, 0.0176256792, 0.0187987952, 0.0148526163, 0.0132142304, 0.0114134489, 0.0112532393, 0.0101071024, 0.0085290581, 0.0078123146,
0.0074906271, 0.0071274465, 0.0055320368, 0.0055132184, 0.0054622208, 0.0040592279, 0.0043408925, 0.0043711776, 0.0036933054, 0.0039284209,
0.0035089432, 0.0035193337, 0.0030272953, 0.0028193867, 0.0023443132, 0.0024718899, 0.0026095623, 0.0020955245, 0.0021521617, 0.0021137040,
0.0021792655, 0.0019000435, 0.0017870031, 0.0016710276, 0.0016570840, 0.0016996471, 0.0015449880, 0.0014959439, 0.0014019533, 0.0012713070,
0.0012514640, 0.0012511919, 0.0011529509, 0.0011688082, 0.0011251825, 0.0008981573, 0.0009830698, 0.0009466416, 0.0008643938, 0.0008853900,
0.0007716729, 0.0007037237, 0.0006819547, 0.0007322556, 0.0008026278, 0.0006745350, 0.0007227847, 0.0014271794, 0.0011857603, 0.0011386009,
0.0010919105, 0.0009128826, 0.0010339643, 0.0009021531, 0.0009446595, 0.0008535231, 0.0008452784, 0.0006427124, 0.0006643324, 0.0007114944,
0.0005739513, 0.0005677666, 0.0005824061, 0.0005067671, 0.0005310312, 0.0004989573, 0.0004133245, 0.0004200988, 0.0004534538, 0.0003904281,
0.0003719468, 0.0003798347, 0.0003098710, 0.0003004792, 0.0003305219, 0.0002629889, 0.0002506170, 0.0002360995, 0.0002548150, 0.0002583708,
0.0002260974, 0.0002281204, 0.0002331338, 0.0002077624, 0.0002022034, 0.0002004780, 0.0002068415, 0.0001828855, 0.0001743010, 0.0001735717,
0.0001818101, 0.0001346604, 0.0001470208, 0.0001513490, 0.0001525853, 0.0001488797, 0.0001430393, 0.0001287955, 0.0001215427, 0.0001316728,
0.0001101619, 0.0001214073, 9.1227661200, 0.0001107811, 0.0001098868, 0.0001035738, 9.0098602700, 8.0348374100, 8.5702800600, 9.2658574400,
7.4200980300, 8.3693179600, 9.7224824900, 7.3724100000, 8.9324717500, 7.8299211100, 8.3049467200, 9.7656172800, 6.8202628600, 8.1631544700,
9.5253691000, 7.5094330000, 7.6849936800, 8.0986801400, 7.2567579600, 8.3052302900, 9.0575720100, 7.7101178600, 9.3635354900, 9.7392976800,
9.9909468200, 8.8696947400, 8.6534233100, 9.4992321300, 9.7747226600, 7.5178510000, 8.4587077400, 9.0872197700, 9.2935240900, 8.5787731000,
9.2418234400, 9.1648751400, 8.7193270900, 6.7877812900, 8.9393610800, 8.8264980200, 9.6207098000, 7.4504300900, 8.6558434200, 9.6637993100,
8.1808641700, 8.9855340200, 9.2062324500, 7.3022094700, 9.1940243600, 9.1081396900, 5.7657804000, 7.9295844200, 7.7076240200, 8.2989131800,
7.1685387600, 9.6173827400, 7.6962590800, 9.8827318100, 7.8648121700, 9.9899018800, 9.2578911200, 7.4050496600, 9.1015376000, 4.2796447127,
4.1758018768, 4.0728657066, 3.9899846826, 3.8989264824, 3.9504566276, 3.8450565524, 3.6688903582, 3.5816089612, 3.8971311556, 3.8069781360,
3.7180257425, 3.6444401182, 3.5455576542, 3.4662067814, 3.1220304455, 3.0089892661, 3.1959791791, 3.1251713611, 3.0556935853, 2.9498333026,
2.8846725232, 2.8215416117, 2.5137007556, 2.4571229710, 2.4033326261, 2.4108357043, 2.3563936002, 2.3024482749, 2.2517393427, 2.2021662470,
2.2349093279, 2.1853253042, 2.0430961712, 1.9898534231, 1.9477176359, 1.9282384005, 1.8871746800, 1.8443689570, 1.7637429001, 1.7240642536,
1.6872163559, 1.6513250056, 1.6181721973, 1.5845146314, 1.5879336413, 1.5530176395, 1.5203943205, 1.4594352829, 1.4239527881, 1.3948933913,
1.3644580054, 1.3358040364, 1.3097509718, 1.2845393340, 1.2544832199, 1.2297690313, 1.2047571846, 1.1786230846, 1.1505963419, 1.1272553942,
1.1039830462, 1.0842471792, 1.0482012374, 1.0275303308, 1.0072703274, 9.8746578241, 9.6268851706, 9.4389994279, 9.2585437170, 9.1201352762,
9.0235341616, 8.8502467749, 8.6023235057, 8.4903632481, 8.2575189264, 8.1000252706, 7.9400217982, 7.7887450408, 7.6103827261, 7.4967478274,
7.3398248868, 7.2622237963, 7.1268176873, 6.9626404327, 6.8348130101, 6.7097418763, 6.5724208399, 6.4482890224, 6.3316725980, 6.2739748753,
6.1475755365, 6.0359546120, 5.9263098679, 5.8248703260, 5.7185408812, 5.6155245549, 5.5256664932, 5.4236304724, 5.3247124065, 0.0000137491,
0.0000131316, 0.0000125453, 0.0000119886, 0.0000114596, 0.0000109570, 0.0000104794, 0.0000100254, 0.0000095935, 0.0000091826, 0.0000087913,
0.0000084187, 0.0000080639, 0.0000077260, 0.0000074040, 0.0000070971, 0.0000068044, 0.0000065251, 0.0000062587, 0.0000060045, 0.0000057618,
0.0000055301, 0.0000053088, 0.0000050974, 0.0000048954, 0.0000047023, 0.0000045177, 0.0000043412, 0.0000041723, 0.0000040108, 0.0000038563,
0.0000037084, 0.0000035667, 0.0000034311, 0.0000033013, 0.0000031768, 0.0000030576, 0.0000029433, 0.0000028338, 0.0000027288, 0.0000026281,
0.0000025315, 0.0000024389, 0.0000023500, 0.0000022647, 0.0000021828, 0.0000021042, 0.0000020287, 0.0000019562, 0.0000018865, 0.0000018196,
0.0000017553, 0.0000016936, 0.0000016342, 0.0000015771, 0.0000015222, 0.0000014694, 0.0000014186, 0.0000013697, 0.0000013227, 0.0000012775,
0.0000012340, 0.0000011921, 0.0000011517, 0.0000011129, 0.0000010755, 0.0000010394, 0.0000010047, 0.0000009713, 0.0000009391, 0.0000009081,
0.0000008781, 0.0000008493, 0.0000008215, 0.0000007947, 0.0000007688, 0.0000007439, 0.0000007198, 0.0000006966, 0.0000007007, 0.0000006783,
0.0000006566, 0.0000006357, 0.0000006155, 0.0000005960, 0.0000005772, 0.0000005591, 0.0000005415, 0.0000005246, 0.0000005082, 0.0000004924,
0.0000004772, 0.0000004624, 0.0000004482, 0.0000004344, 0.0000004211, 0.0000004082, 0.0000003958, 0.0000003837, 0.0000003721, 0.0000003608,
0.0000003500, 0.0000003394, 0.0000003293, 0.0000003194, 0.0000003099, 0.0000003007, 0.0000002917, 0.0000002831, 0.0000002747, 0.0000002667,
0.0000002588, 0.0000002512, 0.0000002439, 0.0000002368, 0.0000002299, 0.0000002232, 0.0000002168, 0.0000002105, 0.0000002045, 0.0000001986,
0.0000001929, 0.0000001874, 0.0000001821, 0.0000001769, 0.0000001719, 0.0000001670, 0.0000001623, 0.0000001577, 0.0000001533, 0.0000001490,
0.0000001448, 0.0000001408, 0.0000001369, 0.0000001331, 0.0000001294, 0.0000001258, 0.0000001224, 0.0000001190, 0.0000001157, 0.0000001126,
0.0000001095, 0.0000001065, 0.0000001036, 0.0000001008, 0.0000000981, 0.0000000954, 0.0000000928, 0.0000000903, 0.0000000879, 0.0000000856,
0.0000000833, 0.0000000810, 0.0000000789, 0.0000000768, 0.0000000748, 0.0000000728, 0.0000000709, 0.0000000690, 0.0000000672, 0.0000000654,
0.0000000637, 0.0000000620, 0.0000000604, 0.0000000588, 0.0000000573, 0.0000000558, 0.0000000544, 0.0000000530, 0.0000000516, 0.0000000503,
0.0000000490, 0.0000000477, 0.0000000465, 0.0000000453, 0.0000000442, 0.0000000431, 0.0000000420, 0.0000000409
  };

  TVectorD massBins(nMassBinTh+1);
  TVectorD XSecTh      (nMassBinTh);
  TVectorD XSecThErr   (nMassBinTh);
  TVectorD normXSecTh      (nMassBinTh);
  TVectorD normXSecThErr   (nMassBinTh);
  double *dblArr=new double[nMassBinTh+1];

  Double_t mxl = 14.0;
  Double_t ZpeakXS=0.;

  for(int iTh=0; iTh<nMassBinTh; iTh++){
    // mass limits
    if     ( iTh >=   0 && iTh <  11 ) {mxl += 1.0;}
    else if( iTh >=  11 && iTh <  18 ) {mxl += 5.0;}
    else if( iTh >=  18 && iTh < 118 ) {mxl += 1.0;}
    else if( iTh >= 118 && iTh < 340 ) {mxl += 2.0;}
    else if( iTh >= 340 && iTh < nMassBinTh)   {mxl += 5.0; }
    else if( iTh == nMassBinTh)                {mxl = 1500; }
    massBins[iTh]=mxl;
    dblArr[iTh]=mxl;
    //std::cout << "iTh=" << iTh << ", mxl=" << mxl << "\n";
    
    XSecTh[iTh]=arr_xsecTh[iTh];
    XSecThErr[iTh]=arr_xsecThErr[iTh];

    if ((mxl>=60) && (mxl<120)) ZpeakXS+=XSecTh[iTh];

    // artificially correct the errors, the reason of them being unreasonably 
    // large is unknown. This scale is an educated guess  (A.J. Sept 08, 2012)
    if (XSecThErr[iTh]>1) XSecThErr[iTh] *= 1e-5;
    
  }
  massBins[nMassBinTh]=1500;
  dblArr[nMassBinTh]=1500;

  for (int iTh=0; iTh<nMassBinTh; ++iTh) {
    const double dm=massBins[iTh+1]-massBins[iTh];
    const double xs=XSecTh[iTh];
    const double xsErr=XSecThErr[iTh];
    normXSecTh[iTh]=xs*peak_bin_width/(peak_val_theory*dm);//divide to the Z peak
    //// error calculation from muon group code
    //normXSecThErr[iTh]=sqrt(pow(xsErr/(peak_val_theory),2)+pow(xs*10./(peak_val_theory*peak_val_theory),2));
    normXSecThErr[iTh]=sqrt(pow(xsErr/(peak_val_theory*dm),2)+pow(xs/(peak_val_theory*2*dm),2));
  }

#ifdef MYTOOLS_HH
  if (0) {
    TH1F *hTh=new TH1F("hTh","hTh",nMassBinTh,dblArr);
    for (int i=1; i<nMassBinTh; ++i) {
      hTh->SetBinContent(i,XSecTh[i-1]);
      hTh->SetBinError(i,XSecThErr[i-1]);
    }
    printHisto(hTh,1);
  }
#endif

  std::cout << "check: ZpeakXS=" << ZpeakXS << ", peak_val_theory=" << peak_val_theory << "\n";

#ifdef Extras
  TVectorD massBins_mb2011_1D(DYTools::_nMassBins2011+1);
  TVectorD XSecTh_mb2011_1D(DYTools::_nMassBins2011);
  TVectorD XSecTh_mb2011_1D_Err(DYTools::_nMassBins2011);
  TVectorD normXSecTh_mb2011_1D(DYTools::_nMassBins2011);
  TVectorD normXSecTh_mb2011_1D_Err(DYTools::_nMassBins2011);
  massBins_mb2011_1D=0;
  XSecTh_mb2011_1D=0; XSecTh_mb2011_1D_Err=0;
  normXSecTh_mb2011_1D=0; normXSecTh_mb2011_1D_Err=0;

  if (save_for_massBinLimits2011_1D) {
    rebinCrossSection(massBins,XSecTh,XSecThErr,
		      DYTools::_nMassBins2011, DYTools::_massBinLimits2011,
		      massBins_mb2011_1D,
		      XSecTh_mb2011_1D, XSecTh_mb2011_1D_Err,
		      normXSecTh_mb2011_1D, normXSecTh_mb2011_1D_Err);
  }
#endif

#ifdef Extras
  TVectorD massBins_spec2011_1D(specRebinCount+1);
  TVectorD XSecTh_spec2011_1D(specRebinCount);
  TVectorD XSecTh_spec2011_1D_Err(specRebinCount);
  TVectorD normXSecTh_spec2011_1D(specRebinCount);
  TVectorD normXSecTh_spec2011_1D_Err(specRebinCount);
  massBins_spec2011_1D=0;
  XSecTh_spec2011_1D=0; XSecTh_spec2011_1D_Err=0;
  normXSecTh_spec2011_1D=0; normXSecTh_spec2011_1D_Err=0;

  if (save_for_massBinLimits2011_1D) {
    rebinCrossSectionSpec(massBins,XSecTh,XSecThErr,
		      massBins_spec2011_1D,
		      XSecTh_spec2011_1D, XSecTh_spec2011_1D_Err,
		      normXSecTh_spec2011_1D, normXSecTh_spec2011_1D_Err);
  }
#endif

  TVectorD massBins_nnlo(41);
  TVectorD normXSecTh_nnlo(40);
  TVectorD normXSecTh_nnloErr(40);
  fillStoyanRShape1D(massBins_nnlo,normXSecTh_nnlo, normXSecTh_nnloErr);

  TString outputDir1(TString("../root_files/theory/"));
  gSystem->mkdir(outputDir1,kTRUE);
  TString xSecResultFileName1(outputDir1+TString("xSectTheory1D_MSTW2008.root"));
  std::cout << "xSecResultFileName1=" << xSecResultFileName1 << "\n";
  TFile fb(xSecResultFileName1,"recreate");
  massBins.Write("massBinsTh");
  XSecTh.Write("xSecTh");
  XSecThErr.Write("xSecThErr");
  normXSecTh.Write("xSecThNorm");
  normXSecThErr.Write("xSecThNormErr");
#ifdef Extras
  massBins_mb2011_1D.Write("massBinsTh_mb2011");
  XSecTh_mb2011_1D.Write("xSecTh_mb2011");
  XSecTh_mb2011_1D_Err.Write("xSecThErr_mb2011");
  normXSecTh_mb2011_1D.Write("xSecThNorm_mb2011");
  normXSecTh_mb2011_1D_Err.Write("xSecThNormErr_mb2011");
#endif
#ifdef Extras
  massBins_spec2011_1D.Write("massBinsTh_spec2011");
  XSecTh_spec2011_1D.Write("xSecTh_spec2011");
  XSecTh_spec2011_1D_Err.Write("xSecThErr_spec2011");
  normXSecTh_spec2011_1D.Write("xSecThNorm_spec2011");
  normXSecTh_spec2011_1D_Err.Write("xSecThNormErr_spec2011");
#endif
  massBins_nnlo.Write("massBinsTh_NNLO");
  normXSecTh_nnlo.Write("xSecThNorm_NNLO");
  normXSecTh_nnloErr.Write("xSecThNormErr_NNLO");

  fb.Close();
}

// -----------------------------------------------------------------

 
